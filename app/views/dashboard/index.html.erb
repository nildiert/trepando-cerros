<div class="container mx-auto p-4 space-y-6" data-controller="analysis">
  <h1 class="text-2xl font-bold">Panel de Carrera</h1>

  <div class="grid gap-6 md:grid-cols-2">
    <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 shadow-lg">
      <h2 class="text-xl font-semibold mb-2">Atleta en Strava</h2>
      <% if @athlete.present? %>
        <p class="text-gray-300"><%= @athlete['firstname'] %> <%= @athlete['lastname'] %></p>
      <% else %>
        <p class="text-gray-400">No se pudo cargar la informaci√≥n de Strava.</p>
      <% end %>
    </div>

    <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 shadow-lg">
      <h2 class="text-xl font-semibold mb-2">Calcula tu tiempo estimado</h2>
      <%= form_with url: root_path, method: :post, data: { controller: 'analysis', action: 'submit->analysis#submit', turbo: false }, local: true, multipart: true do %>
        <div class="mb-4">
          <%= label_tag :gpx_file, 'Sube tu ruta GPX', class: 'block' %>
          <%= file_field_tag :gpx_file, class: 'border p-2 w-full text-gray-900' %>
        </div>
        <%= submit_tag 'Calcular', class: 'bg-blue-600 text-white px-4 py-2 rounded cursor-pointer hover:bg-blue-500' %>
      <% end %>
      <div data-analysis-target="loader" class="hidden flex items-center space-x-2 mt-4">
        <div class="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-blue-400"></div>
        <span>Analizando...</span>
      </div>
      <div class="w-full bg-gray-700 rounded h-2 mt-2 overflow-hidden">
        <div data-analysis-target="bar" class="bg-blue-500 h-full w-0 transition-all duration-500"></div>
      </div>
      <div data-analysis-target="messages" class="text-sm mt-2 space-y-1"></div>
    </div>
  </div>

  <% if @estimated_time %>
    <div class="grid gap-6 md:grid-cols-2">
      <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 shadow-lg">
        <p class="font-bold mb-4">Tiempo estimado: <%= @estimated_time %></p>
        <ul class="space-y-1 text-gray-300">
          <% @hourly_progress.each do |(hour, dist)| %>
            <li>Hora <%= hour %>: <%= dist %> km</li>
          <% end %>
        </ul>
      </div>

      <div class="bg-white/10 backdrop-blur-md rounded-xl p-6 shadow-lg">
        <canvas id="profileChart" class="w-full h-56"></canvas>
      </div>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const data = {
          labels: <%= raw(@profile_data[:distance_km].to_json) %>,
          datasets: [{
            label: 'Elevaci\u00f3n (m)',
            data: <%= raw(@profile_data[:elevation_m].to_json) %>,
            fill: true,
            borderColor: 'rgb(59,130,246)',
            backgroundColor: 'rgba(59,130,246,0.3)',
            tension: 0.4
          }]
        };
        new Chart(document.getElementById('profileChart'), {
          type: 'line',
          data,
          options: {
            plugins: { legend: { display: false } },
            scales: {
              x: { title: { display: true, text: 'Distancia (km)' } },
              y: { title: { display: true, text: 'Elevaci\u00f3n (m)' } }
            },
            animation: { duration: 1000 }
          }
        });
      });
    </script>
  <% elsif flash[:alert] %>
    <p class="text-red-600"><%= flash[:alert] %></p>
  <% end %>
</div>
